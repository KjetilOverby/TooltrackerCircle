// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_DIRECT_URL")
}

model Post {
  id        Int      @id @default(autoincrement())
  name      String
  orgId     String // Clerk org ID
  userId    String // koblet til Clerk userId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId])
  @@index([userId])
}

model Saw {
  id    String @id @default(cuid())
  orgId String

  name    String
  sawType String? // f.eks. "Canter", "Resaw", "Kappsag"
  active  Boolean @default(true)
  side    String?

  note String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  createdById      String? // Clerk user id (valgfritt)
  // NYE FELT FOR MÅLTALL
  targetEfficiency Float?   @default(300) // Mål i stokker/t
  targetOEE        Float?   @default(85) // Mål i prosent (f.eks 85%)

  installs BladeInstall[]

  @@unique([orgId, name])
  @@index([orgId])
}

model BladeType {
  id    String @id @default(cuid())
  orgId String

  name            String // f.eks. "Bånd 75x1.1 22TPI", "Kappsag 350mm", osv.
  note            String?
  hasSide         Boolean @default(false) // om bladet har "side"-egenskap
  lagerBeholdning Int?    @default(0)

  active Boolean @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String? // Clerk user id
  artikkel    String?

  blades SawBlade[]

  @@unique([orgId, name])
  @@index([orgId])
}

model SawBlade {
  id    String @id @default(cuid())
  orgId String

  /// Serienummer / ID-nummer på bladet (unikt innen bedriften)
  IdNummer String

  kunde String? // hvis du vil beholde dette
  note  String?

  produsent String?
  artikkel  String?
  side      String?

  bladeTypeId String
  bladeType   BladeType @relation(fields: [bladeTypeId], references: [id], onDelete: Restrict)

  deleted      Boolean @default(false)
  deleteReason String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String? // Clerk user id

  installs BladeInstall[]
  services BladeService[]

  @@unique([orgId, IdNummer])
  @@index([orgId])
  @@index([orgId, bladeTypeId])
}

model BladeInstall {
  id    String @id @default(cuid())
  orgId String

  bladeId String
  blade   SawBlade @relation(fields: [bladeId], references: [id], onDelete: Restrict)

  sawId String
  saw   Saw    @relation(fields: [sawId], references: [id], onDelete: Restrict)

  /// Når bladet settes inn i saga (dato+kl)
  installedAt   DateTime
  installedById String? // Clerk user id

  /// Når bladet tas ut (dato+kl)
  removedAt   DateTime?
  removedById String? // Clerk user id

  /// NYTT: Årsak / kategori for uttak/bytte (lagres på historikken)
  /// Eksempelverdier: "Sløvt", "Tannbrudd", "Sporing", "Produksjonsskifte", "Flyttet", "Annet"
  removedReason String?
  /// NYTT: Utfyllende tekst til årsak (valgfritt)
  removedNote   String?

  /// Valgfritt: hvis "side" varierer per installasjon
  side String?

  /// Generell note for installasjonen
  note String?

  /// VALGFRITT: Knytter uttaket til en service (hvis du oppretter BladeService)
  serviceId String?
  service   BladeService? @relation(fields: [serviceId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  runLog BladeRunLog?

  @@index([orgId])
  @@index([orgId, bladeId])
  @@index([orgId, sawId])
  @@index([orgId, installedAt])
  @@index([orgId, removedAt])
  /// For å finne "aktivt blad i sag": where orgId, sawId, removedAt=null
  @@index([orgId, sawId, removedAt])
  /// For å finne "er bladet aktivt montert et sted": where orgId, bladeId, removedAt=null
  @@index([orgId, bladeId, removedAt])
  /// Praktisk for rapporter/filtrering på årsak
  @@index([orgId, removedReason])
}

model BladeService {
  id    String @id @default(cuid())
  orgId String

  bladeId String
  blade   SawBlade @relation(fields: [bladeId], references: [id], onDelete: Restrict)

  serviceType String?
  datoInn     DateTime
  datoUt      DateTime?

  antRep       Int     @default(0)
  antTannslipp Int     @default(0)
  feilkode     String?

  // Kobling til loggføringen av handlinger
  actions ServiceAction[]

  note         String?
  noteCustomer String?
  noteSupplier String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String?

  installs BladeInstall[]

  @@index([orgId])
  @@index([orgId, bladeId])
  @@index([orgId, datoInn])
}

// 1. Denne tabellen logger at en spesifikk kode ble brukt på en spesifikk service
model ServiceAction {
  id        String       @id @default(cuid())
  serviceId String
  service   BladeService @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  // Peker til hvilken kode som ble brukt
  kodeId String
  kode   ServiceKode @relation(fields: [kodeId], references: [id])

  createdAt DateTime @default(now())

  @@index([serviceId])
  @@index([kodeId])
}

// 2. Denne tabellen er "menyen" (SERV 402, SERV 407 osv)
model ServiceKode {
  id    String @id @default(cuid())
  orgId String
  code  String // f.eks "SERV 402"
  name  String // f.eks "SLIP HM/STELLIT"

  // Relasjon tilbake for å se all bruk av denne koden
  usedIn ServiceAction[]

  @@unique([orgId, code])
  @@index([orgId])
}

model BladeRunLog {
  id    String @id @default(cuid())
  orgId String

  /// Knytter målinger/hendelser til en spesifikk installasjon
  installId String       @unique
  install   BladeInstall @relation(fields: [installId], references: [id], onDelete: Cascade)

  /// Når dette ble logget (kan være ved stopp/feil/service etc)
  loggedAt DateTime @default(now())

  /// Felt som ligner det du har i bandhistorikk (juster fritt)
  sagtid     Float?
  feilkode   String?
  temperatur Int?

  sideklaring Float?
  ampere      Float?
  stokkAnt    Int?

  /// Hvis du trenger ekstra tekstfelt
  alt String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String? // Clerk user id

  @@index([orgId])
  @@index([orgId, installId])
  @@index([orgId, loggedAt])
}
